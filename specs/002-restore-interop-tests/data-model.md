# Data Model: C# Interop Tests for Restore Transitive Dependencies

**Date**: 2025-11-01
**Status**: Complete

## Overview

This document defines the data structures used in C# interop tests for validating gonuget's restore transitive dependency resolution against NuGet.Client.

## Entities

### 1. TestProject

Represents a .NET project file (.csproj) with PackageReference entries for testing restore behavior.

**Attributes**:
- `Name` (string): Project name (e.g., "TestApp")
- `Path` (string): Absolute path to .csproj file
- `TargetFramework` (string): Target framework moniker (e.g., "net9.0", "net6.0")
- `PackageReferences` (List<PackageReference>): List of package dependencies

**Relationships**:
- Has many PackageReferences (1:N)
- Generates one RestoreResult when restored (1:1)

**Lifecycle**:
- Created: Programmatically generated in test setup
- Used: Passed to GonugetBridge.RestoreTransitive() and NuGet.Client restore
- Disposed: Cleaned up after test completion (temp directory deleted)

**Validation Rules**:
- Name must not be empty
- TargetFramework must be valid TFM format
- PackageReferences list can be empty (valid for testing no-dependency scenario)
- Path must be writable location

---

### 2. PackageReference

Represents a single package dependency in a .NET project.

**Attributes**:
- `PackageId` (string): NuGet package identifier (e.g., "Newtonsoft.Json")
- `Version` (string): Version or version range (e.g., "13.0.4", "[13.0.0,)")
- `IncludePrerelease` (bool): Whether to include prerelease versions

**Relationships**:
- Belongs to one TestProject (N:1)

**Validation Rules**:
- PackageId must not be empty
- Version must be valid NuGet version string or range

---

### 3. RestoreResult

Captures the outcome of a restore operation, including resolved packages, categorization, and any errors.

**Attributes**:
- `Success` (bool): Whether restore completed without errors
- `DirectPackages` (List<ResolvedPackage>): Packages explicitly listed in project file
- `TransitivePackages` (List<ResolvedPackage>): Packages pulled in as dependencies
- `UnresolvedPackages` (List<UnresolvedPackage>): Packages that could not be resolved
- `LockFilePath` (string): Path to generated project.assets.json
- `ElapsedMs` (long): Restore execution time in milliseconds
- `ErrorMessages` (List<string>): Error messages (NU1101, NU1102, NU1103)

**Relationships**:
- Belongs to one TestProject (1:1)
- Has many ResolvedPackages (1:N)
- Has many UnresolvedPackages (1:N)
- References one LockFile via LockFilePath (1:1)

**State Transitions**:
```
[Initial] → [Restoring] → [Success OR Failure]
                ↓                ↓
         DirectPackages +    ErrorMessages
         TransitivePackages  UnresolvedPackages
         LockFile
```

**Validation Rules**:
- If Success=true, UnresolvedPackages and ErrorMessages must be empty
- If Success=false, ErrorMessages must not be empty
- DirectPackages and TransitivePackages should be mutually exclusive (no package in both lists)

---

### 4. ResolvedPackage

Represents a successfully resolved package with version and installation path.

**Attributes**:
- `PackageId` (string): NuGet package identifier
- `Version` (string): Resolved version (exact version, not range)
- `Path` (string): Path to package in global packages folder
- `IsDirect` (bool): True if directly referenced in project file, false if transitive

**Relationships**:
- Belongs to one RestoreResult (N:1)

**Validation Rules**:
- PackageId must not be empty
- Version must be exact version (not range)
- Path must exist in file system after restore

---

### 5. UnresolvedPackage

Represents a package that could not be found or resolved, with diagnostic information.

**Attributes**:
- `PackageId` (string): NuGet package identifier
- `VersionRange` (string): Requested version or version range
- `TargetFramework` (string): Target framework moniker
- `ErrorCode` (string): NuGet error code (NU1101, NU1102, NU1103)
- `Message` (string): Full error message
- `Sources` (List<string>): Package sources queried
- `AvailableVersions` (List<string>): Versions found (for NU1102/NU1103)
- `NearestVersion` (string): Closest version match (for NU1102/NU1103)

**Relationships**:
- Belongs to one RestoreResult (N:1)

**Validation Rules**:
- ErrorCode must be NU1101, NU1102, or NU1103
- If ErrorCode=NU1101, AvailableVersions must be empty
- If ErrorCode=NU1102 or NU1103, AvailableVersions must not be empty

---

### 6. LockFile (project.assets.json)

Represents the parsed lock file structure generated by restore.

**Attributes**:
- `Version` (int): Lock file format version (currently 3)
- `Targets` (Dictionary<string, Target>): Framework-specific package targets
- `Libraries` (Dictionary<string, Library>): All packages (direct + transitive)
- `ProjectFileDependencyGroups` (Dictionary<string, List<string>>): Direct dependencies per framework
- `PackageFolders` (Dictionary<string, PackageFolder>): Package folder paths
- `Project` (ProjectInfo): Project metadata

**Relationships**:
- Referenced by one RestoreResult (1:1)
- Has many Libraries (1:N)
- Has many Targets (1:N)

**Validation Rules**:
- Version must be 3 (current NuGet lock file format)
- Libraries map keys must be lowercase package IDs with version (e.g., "newtonsoft.json/13.0.4")
- ProjectFileDependencyGroups must contain ONLY direct dependencies (not transitive)

---

### 7. Library

Represents a library entry in the lock file Libraries map.

**Attributes**:
- `Key` (string): Package ID and version (e.g., "newtonsoft.json/13.0.4")
- `Type` (string): Library type (typically "package")
- `Path` (string): Relative path to package (lowercase)
- `Sha512` (string): Package hash
- `Files` (List<string>): Files in package

**Relationships**:
- Belongs to one LockFile (N:1)

**Validation Rules**:
- Key must be lowercase
- Path must be lowercase
- Type must be "package" for NuGet packages

---

### 8. LockFileComparison

Represents the semantic comparison result between two project.assets.json files.

**Attributes**:
- `AreEqual` (bool): Overall equality result
- `LibrariesMatch` (bool): Libraries map keys and structure match
- `ProjectFileDependencyGroupsMatch` (bool): Direct dependency groups match
- `VersionsMatch` (bool): Package versions match
- `PathsMatch` (bool): Package paths match (including lowercase requirement)
- `Differences` (List<string>): Human-readable list of differences

**Relationships**:
- Compares two LockFile instances (2:1)

**Validation Rules**:
- If AreEqual=true, all match flags must be true and Differences must be empty
- If AreEqual=false, at least one match flag must be false and Differences must not be empty

---

### 9. ErrorMessageValidation

Represents the comparison result between gonuget and NuGet.Client error messages.

**Attributes**:
- `ErrorCode` (string): NuGet error code (NU1101, NU1102, NU1103)
- `GonugetMessage` (string): Error message from gonuget
- `NuGetClientMessage` (string): Error message from NuGet.Client
- `Match` (bool): Whether messages match (allowing for formatting tolerance)
- `Differences` (List<string>): Specific differences found

**Relationships**:
- Compares error messages for one UnresolvedPackage (1:1)

**Validation Rules**:
- ErrorCode must be NU1101, NU1102, or NU1103
- If Match=true, Differences must be empty
- If Match=false, Differences must not be empty

---

## Entity Relationships Diagram

```
TestProject
    │
    ├─1:N─> PackageReference
    │
    └─1:1─> RestoreResult
                │
                ├─1:N─> ResolvedPackage (Direct)
                ├─1:N─> ResolvedPackage (Transitive)
                ├─1:N─> UnresolvedPackage
                │           │
                │           └─1:1─> ErrorMessageValidation
                │
                └─1:1─> LockFile
                            │
                            ├─1:N─> Library
                            ├─1:N─> Target
                            │
                            └─1:1─> LockFileComparison
```

## Usage Examples

### Creating a Test Project

```csharp
var project = new TestProject("TestApp", "net9.0")
    .AddPackage("Newtonsoft.Json", "13.0.4")
    .AddPackage("Serilog.Sinks.File", "5.0.0");
```

### Comparing Restore Results

```csharp
var gonugetResult = GonugetBridge.RestoreTransitive(project.Path);
var nugetResult = NuGetClientRestore(project.Path);

Assert.Equal(nugetResult.DirectPackages.Count, gonugetResult.DirectPackages.Count);
Assert.Equal(nugetResult.TransitivePackages.Count, gonugetResult.TransitivePackages.Count);
```

### Validating Lock File

```csharp
var comparison = GonugetBridge.CompareProjectAssets(
    gonugetResult.LockFilePath,
    nugetResult.LockFilePath
);

Assert.True(comparison.AreEqual, string.Join("\n", comparison.Differences));
Assert.True(comparison.LibrariesMatch);
Assert.True(comparison.ProjectFileDependencyGroupsMatch);
```

### Validating Error Messages

```csharp
var validation = GonugetBridge.ValidateErrorMessages(
    gonugetResult.ErrorMessages[0],
    nugetResult.ErrorMessages[0]
);

Assert.True(validation.Match, string.Join("\n", validation.Differences));
Assert.Equal("NU1101", validation.ErrorCode);
```

## Notes

- All entities are technology-agnostic descriptions of test data structures
- C# implementation will use classes with properties matching these attributes
- Go implementation (gonuget-interop-test handlers) will use structs with JSON tags
- Relationships guide test organization and assertion logic
- Validation rules ensure data integrity and test correctness
