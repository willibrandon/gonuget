# M3.15: Framework Formatting and PCL Parsing

## Overview
Implement full NuGet.Client-compatible framework formatting (`format()`) and PCL parsing (`parsePCL()`) to ensure exact TFM string generation and portable framework profile resolution.

## Current State
- `format()`: Returns only `fw.Framework` (identifier only)
- `parsePCL()`: Stores raw profile string without profile number lookup

## NuGet.Client Implementation

### format() / GetShortFolderName()
**Location**: `NuGet.Client/src/NuGet.Core/NuGet.Frameworks/NuGetFramework.cs:196-296`

**Algorithm**:
1. Check for short name replacements (special rewrites)
2. Handle special frameworks (Any, Agnostic, Unsupported) → return identifier as-is
3. Get short identifier from mappings (e.g., ".NETFramework" → "net")
4. Append version string using mapping provider
5. Handle three cases:
   - **PCL**: Recursively format child frameworks, sort alphabetically, join with "+"
   - **.NET 5+ with platform**: Append `-platform` + platform version
   - **Other with profile**: Append `-profile`
6. Return lowercase

**Key Components**:
```csharp
// Get short identifier
mappings.TryGetShortIdentifier(GetFrameworkIdentifier(), out shortFramework)

// Get version string
mappings.GetVersionString(framework.Framework, framework.Version)

// PCL handling
if (IsPCL) {
    mappings.TryGetPortableFrameworks(framework.Profile, includeOptional: false, out frameworks)
    var sortedFrameworks = required.Select(e => e.GetShortFolderName(mappings))
                                    .OrderBy(e => e, StringComparer.OrdinalIgnoreCase);
    sb.Append(string.Join("+", sortedFrameworks));
}

// .NET 5+ platform
if (IsNet5Era && !string.IsNullOrEmpty(framework.Platform)) {
    sb.Append("-");
    sb.Append(framework.Platform.ToLowerInvariant());
    if (framework.PlatformVersion != EmptyVersion) {
        sb.Append(mappings.GetVersionString(framework.Framework, framework.PlatformVersion));
    }
}

// Profile
if (framework.HasProfile && !mappings.TryGetShortProfile(framework.Framework, framework.Profile, out shortProfile)) {
    shortProfile = framework.Profile;
}
if (!string.IsNullOrEmpty(shortProfile)) {
    sb.Append("-");
    sb.Append(shortProfile);
}
```

### parsePCL() / ParseFolder() PCL handling
**Location**: `NuGet.Client/src/NuGet.Core/NuGet.Frameworks/NuGetFrameworkFactory.cs:336-354`

**Algorithm**:
1. Parse profile string (e.g., "net45+win8+wpa81") into child frameworks
2. Call `TryGetPortableFrameworks` to get framework list
3. Call `TryGetPortableProfile` to map frameworks → profile number (e.g., Profile259)
4. Create framework with `.NETPortable`, version 0.0, and profile string "Profile259"
5. If no mapping found, store raw profile string
6. Return `UnsupportedFramework` if parsing fails

**Key Components**:
```csharp
if (StringComparer.OrdinalIgnoreCase.Equals(FrameworkConstants.FrameworkIdentifiers.Portable, framework)) {
    if (!mappings.TryGetPortableFrameworks(profileShort, out clientFrameworks)) {
        result = UnsupportedFramework;
    } else {
        int profileNumber = -1;
        if (mappings.TryGetPortableProfile(clientFrameworks, out profileNumber)) {
            var portableProfileNumber = FrameworkNameHelpers.GetPortableProfileNumberString(profileNumber);
            result = new NuGetFramework(framework, version, portableProfileNumber);
        } else {
            result = new NuGetFramework(framework, version, profileShort);
        }
    }
}
```

## Required Mappings Data

### 1. Short Identifier Mappings
```
.NETFramework    → net
.NETStandard     → netstandard
.NETCoreApp      → netcoreapp
.NETPortable     → portable
```

### 2. Version String Formatting
- For .NET Framework: "48" for 4.8, "472" for 4.7.2
- For .NET Standard/Core: "2.0", "3.1"
- For .NET 5+: "6.0", "8.0"

### 3. Portable Profile Mappings
Key profiles (from DefaultPortableFrameworkMappings.cs):
```
Profile7   = net45+win8
Profile31  = win81+wpa81
Profile32  = win81+wpa81
Profile44  = net451+win81
Profile49  = net45+wp8
Profile78  = net45+win8+wp8+wpa81
Profile84  = wp81+wpa81
Profile111 = net45+win8+wpa81
Profile151 = net451+win81+wpa81
Profile157 = win81+wp81+wpa81
Profile259 = net45+win8+wpa81+wp8
```

### 4. Profile Short Name Mappings
```
Client          → client (for .NETFramework)
Full            → (empty)
WindowsPhone    → wp
WindowsPhone71  → wp71
```

## Implementation Plan

### Phase 1: Framework Name Provider (gonuget/frameworks/provider.go)
```go
type FrameworkNameProvider interface {
    // TryGetShortIdentifier gets the short framework name
    TryGetShortIdentifier(identifier string) (string, bool)

    // GetVersionString formats a version for the given framework
    GetVersionString(framework string, version FrameworkVersion) string

    // TryGetShortProfile gets the short profile name
    TryGetShortProfile(framework, profile string) (string, bool)

    // TryGetPortableFrameworks parses a portable profile string into frameworks
    TryGetPortableFrameworks(profile string, includeOptional bool) ([]*NuGetFramework, bool)

    // TryGetPortableProfile gets the profile number for a set of frameworks
    TryGetPortableProfile(frameworks []*NuGetFramework) (int, bool)
}

type defaultFrameworkNameProvider struct {
    identifierMappings map[string]string
    profileMappings map[string]string
    portableProfiles map[string][]string // profile string -> framework list
    portableProfileNumbers map[string]int // sorted framework list -> profile number
}

func DefaultFrameworkNameProvider() FrameworkNameProvider {
    return &defaultFrameworkNameProvider{
        identifierMappings: map[string]string{
            ".NETFramework": "net",
            ".NETStandard":  "netstandard",
            ".NETCoreApp":   "netcoreapp",
            ".NETPortable":  "portable",
        },
        // ... populate other mappings
    }
}
```

### Phase 2: Update format() method
```go
func (fw *NuGetFramework) format() string {
    return fw.GetShortFolderName(DefaultFrameworkNameProvider())
}

func (fw *NuGetFramework) GetShortFolderName(provider FrameworkNameProvider) string {
    var sb strings.Builder

    // Handle special frameworks
    if !fw.IsSpecificFramework() {
        return strings.ToLower(fw.Framework)
    }

    // Get short identifier
    shortFramework, ok := provider.TryGetShortIdentifier(fw.Framework)
    if !ok {
        shortFramework = getLettersAndDigitsOnly(fw.Framework)
    }

    sb.WriteString(shortFramework)

    // Add version
    if !fw.AllFrameworkVersions {
        sb.WriteString(provider.GetVersionString(fw.Framework, fw.Version))
    }

    // Handle PCL
    if fw.IsPCL() {
        sb.WriteString("-")
        if frameworks, ok := provider.TryGetPortableFrameworks(fw.Profile, false); ok {
            // Recursively format each framework
            shortNames := make([]string, len(frameworks))
            for i, child := range frameworks {
                shortNames[i] = child.GetShortFolderName(provider)
            }
            // Sort alphabetically
            sort.Strings(shortNames)
            sb.WriteString(strings.Join(shortNames, "+"))
        }
    } else if fw.IsNet5Era() && fw.Platform != "" {
        // .NET 5+ platform
        sb.WriteString("-")
        sb.WriteString(strings.ToLower(fw.Platform))
        if !fw.PlatformVersion.IsEmpty() {
            sb.WriteString(provider.GetVersionString(fw.Framework, fw.PlatformVersion))
        }
    } else if fw.Profile != "" {
        // Regular profile
        shortProfile, ok := provider.TryGetShortProfile(fw.Framework, fw.Profile)
        if !ok {
            shortProfile = fw.Profile
        }
        if shortProfile != "" {
            sb.WriteString("-")
            sb.WriteString(shortProfile)
        }
    }

    return strings.ToLower(sb.String())
}
```

### Phase 3: Update parsePCL()
```go
func parsePCL(s string) (*NuGetFramework, error) {
    s = strings.TrimPrefix(s, "portable-")

    provider := DefaultFrameworkNameProvider()

    // Try to parse profile string into frameworks
    frameworks, ok := provider.TryGetPortableFrameworks(s, false)
    if !ok {
        // No mapping found, return unsupported
        return &NuGetFramework{
            Framework: "Unsupported",
            originalString: "portable-" + s,
        }, nil
    }

    // Try to get profile number
    profileNumber, ok := provider.TryGetPortableProfile(frameworks)
    var profile string
    if ok {
        profile = fmt.Sprintf("Profile%d", profileNumber)
    } else {
        profile = s
    }

    return &NuGetFramework{
        Framework:      ".NETPortable",
        Version:        FrameworkVersion{},
        Profile:        profile,
        originalString: "portable-" + s,
    }, nil
}
```

## Testing Strategy

### format() Tests
```go
func TestFormat(t *testing.T) {
    tests := []struct{
        fw *NuGetFramework
        want string
    }{
        {&NuGetFramework{Framework: ".NETFramework", Version: v(4,8,0,0)}, "net48"},
        {&NuGetFramework{Framework: ".NETStandard", Version: v(2,0,0,0)}, "netstandard2.0"},
        {&NuGetFramework{Framework: ".NETCoreApp", Version: v(6,0,0,0)}, "net6.0"},
        {&NuGetFramework{Framework: ".NETCoreApp", Version: v(6,0,0,0), Platform: "windows", PlatformVersion: v(10,0,0,0)}, "net6.0-windows10.0"},
        {&NuGetFramework{Framework: ".NETPortable", Profile: "Profile259"}, "portable-net45+win8+wp8+wpa81"},
    }
    // ...
}
```

### parsePCL() Tests
```go
func TestParsePCL(t *testing.T) {
    tests := []struct{
        input string
        wantFramework string
        wantProfile string
    }{
        {"portable-net45+win8", ".NETPortable", "Profile7"},
        {"portable-net45+win8+wp8+wpa81", ".NETPortable", "Profile259"},
        {"portable-unknown+frameworks", ".NETPortable", "unknown+frameworks"}, // No mapping
    }
    // ...
}
```

## Acceptance Criteria
- [ ] `format()` returns exact TFM strings matching NuGet.Client for all framework types
- [ ] PCL frameworks format with sorted child frameworks (e.g., "portable-net45+win8+wp8+wpa81")
- [ ] `parsePCL()` resolves profile numbers correctly (e.g., "portable-net45+win8" → Profile7)
- [ ] .NET 5+ platforms format correctly (e.g., "net6.0-windows10.0")
- [ ] Profiles format correctly (e.g., "net40-client" → "net40-client")
- [ ] All tests pass with 90%+ coverage

## References
- NuGet.Client: `src/NuGet.Core/NuGet.Frameworks/NuGetFramework.cs:196-296`
- NuGet.Client: `src/NuGet.Core/NuGet.Frameworks/NuGetFrameworkFactory.cs:336-354`
- NuGet.Client: `src/NuGet.Core/NuGet.Frameworks/DefaultFrameworkNameProvider.cs`
- NuGet.Client: `src/NuGet.Core/NuGet.Frameworks/DefaultPortableFrameworkMappings.cs`
